# Laravel-2024

## Требования

- Docker, Docker-Compose
- Make
- Git

## Запуск сервиса

#### 1. Клонируем репозиторий сервиса и переходим в создавшуюся директорию.
```
git clone https://github.com/IvanIvanchenko/Laravel-2024.git && cd Laravel-2024
```

#### 2. Копируем файлы окружения и настраиваем.
```
make setup
```

Файл .env должен содержать следующие переменные:

```
SERVER_PORT - порт на котором будет запущен сервис
```
Также нужно прописать UID и GID вашего пользователя

Это нужно чтобы внтури докер-контейнера php действовал тот же пользователь что и "снаружи". Иначе будут проблемы с правами в разных местах.

Получаем свои UID и GID набрав в консоли:
```
$ id -u
1000
$ id -g
1000
```
Проставляем их в .env:
```
UID=1000
GID=1000
```

#### 3. Запускаем проект в докере
```
make start
```

#### 4. При запуске приложения в первый раз нужно проставить ключ приложения (в .env файле константа APP_KEY) и установить зависимости с помощью команды
```
make laravel-setup
```

#### 5. При запуске приложения в первый раз нужно запустить скрипты миграций
```
make laravel-migrate
```

## Константы
- SERVER_PORT - порт контейнера nginx. По нему будет работать сервис.
- UID - UID пользователя от которого будут работать различные процессы внутри php контейнера, должен совпадать с UID пользователя, от имени которого разворачивается и запускается сервис
- GID - GID группы пользователя от которого будут работать различные процессы внутри php контейнера, должен совпадать с GID группы пользователя, от имени которого разворачивается и запускается сервис


## Request Docs приложения
```
http://localhost/request-docs/
```
## Асинхронная обработка
Задачи создаются при добавлении нового поста, когда отправляется уведомление на почту. Задача сохраняется в базе данных и обрабатывается асинхронно, не влияя на скорость ответа API.

## QueryLoggingServiceProvider

#### Описание

`QueryLoggingServiceProvider` — сервис-провайдер, для логирования SQL-запросов в локальной среде.

#### Установка

1. Провайдер уже зарегистрирован в `config/app.php`:
2. Работает только в локальной среде (чтобы не засорять логи в продакшене), когда в `.env` файле установлено:
    ```
    APP_ENV=local
    ```
3. Логи SQL-запросов будут записываться в файл логов `storage/logs/laravel.log`.

## Event: UserActivityLogged
#### Описание
Событие генерируется при каждом запросе к API для записи активности пользователя.
#### Параметры
```
userId: ID пользователя.
route: Имя маршрута.
method: HTTP-метод.
status: HTTP-код ответа.
duration: Время выполнения запроса в миллисекундах.
```
## Listener: LogUserActivity
#### Описание
Слушатель обрабатывает событие UserActivityLogged и сохраняет данные в таблицу user_activities.
## Middleware: LogUserActivityMiddleware
#### Описание
Middleware генерирует событие UserActivityLogged при каждом запросе к API, записывая информацию о пользователе, маршруте, методе HTTP, статусе ответа и времени выполнения запроса.

## Команда Artisan: report:user-activity
#### Описание
Генерирует отчет о действиях пользователя за последние 30 дней.
#### Параметры
```
{userId}: ID пользователя.
--file=: Путь для сохранения отчета в формате CSV.
```


## В данном проекте реализованы следующие задания
#### 1. Создайте новое Laravel-приложение.
1. Настройте Docker/Docker compose.
2. Настройте подключение к базе данных.
3. Создайте базовую структуру приложения, включая настройку .env файла.

#### 2. CRUD операции для пользователей
1. Создайте контроллер UserController.
2. Реализуйте методы для CRUD API (создание, чтение, обновление, удаление) пользователей.
3. Настройте маршруты для этих операций.
4. Добавьте валидацию для создания и обновления пользователей с использованием Form Requests.
5. Формируйте ответ REST API через API Resource.

#### 3. Авторизация и аутентификация
1. Реализуйте регистрацию и авторизацию пользователей с использованием Laravel Sanctum.
2. Настройте middleware для защиты маршрутов, требующих авторизации.
3. Реализуйте функционал сброса пароля через email.

#### 4. Связь моделей и отношения
1. Создайте модель Post и миграцию для таблицы posts (id, title, body, author_id, created_at, updated_at).
2. Настройте отношения User (один ко многим) с Post.
3. Реализуйте CRUD API для Post.
4. Данные API помимо информации Post должны содержать имя автора поста.

#### 5. Фильтрация, сортировка и пагинация
1. Добавьте возможность фильтрации и сортировки постов по всем параметрам.
2. Реализуйте пагинацию для списков постов.

#### 6. События и слушатели
1. Создайте событие PostCreated.
2. Создайте слушатель SendPostCreatedNotification, который отправляет email уведомление при создании нового поста.
3. Настройте систему событий и слушателей в Laravel.

#### 7. Асинхронная обработка задач
1. Реализуйте очередь задач для асинхронной обработки (например, отправка email уведомлений) с использованием Laravel Queue.
2. Настройте работу supervisor в рамках docker.
3. Документируйте и протестируйте асинхронные задачи.

#### 8. Сервис-провайдеры и модификация работы приложения
1. Создайте кастомный сервис-провайдер, который модифицирует стандартное поведение приложения - добавляет логирование всех SQL-запросов при работе в локальной среде.
2. Настройте сервис-провайдер для автоматического включения в процессе загрузки приложения.
3. Документируйте процесс создания и использования сервис-провайдера в README.

#### 9. Расширенная обработка данных и событий
1. Создайте событие UserActivityLogged.
2. Создайте слушателя LogUserActivity, который обрабатывает событие и сохраняет данные о действиях пользователей в отдельную таблицу user_activities.
3. Реализуйте middleware, который будет генерировать событие UserActivityLogged при каждом запросе к API, записывая информацию о пользователе, маршруте, методе HTTP, статусе ответа и времени запроса.
4. Создайте кастомную команду Artisan php artisan report:user-activity {userId}, которая генерирует отчет о действиях пользователя за последние 30 дней, отображая данные в консоли или сохраняя их в файл в формате csv.
5. Документируйте процесс создания и использования этой системы в README.
